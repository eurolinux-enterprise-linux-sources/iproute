From 8d4319c9522b6c0c8a972f8ccc2bc192f645b4d9 Mon Sep 17 00:00:00 2001
From: Phil Sutter <psutter@redhat.com>
Date: Tue, 8 Dec 2015 17:58:26 +0100
Subject: [RHEL6.8 PATCH] prevent the read ahead of /proc/slabinfo in ss

Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1289312

commit a221d621bb4af414b974ccc40bba26481337d7cf
Author: Bryton Lee <brytonlee01@gmail.com>
Date:   Thu Feb 12 14:16:04 2015 +0800

    prevent the read ahead of /proc/slabinfo in ss

    Signed-off-by: Bryton Lee <brytonlee01@gmail.com>

Signed-off-by: Phil Sutter <psutter@redhat.com>
---
 misc/ss.c | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/misc/ss.c b/misc/ss.c
index e1f93fb4c2a6e..86d9f6f32fe0d 100644
--- a/misc/ss.c
+++ b/misc/ss.c
@@ -290,7 +290,7 @@ struct slabstat
 	int skbs;
 };
 
-struct slabstat slabstat;
+static struct slabstat slabstat;
 
 static const char *slabstat_ids[] =
 {
@@ -306,6 +306,10 @@ int get_slabstat(struct slabstat *s)
 	char buf[256];
 	FILE *fp;
 	int cnt;
+	static int slabstat_valid;
+
+	if (slabstat_valid)
+		return 0;
 
 	memset(s, 0, sizeof(*s));
 
@@ -329,6 +333,8 @@ int get_slabstat(struct slabstat *s)
 			break;
 	}
 
+	slabstat_valid = 1;
+
 	fclose(fp);
 	return 0;
 }
@@ -1636,6 +1642,8 @@ static int tcp_show(struct filter *f, int socktype)
 	 * it is able to give us some memory for snapshot.
 	 */
 	if (1) {
+		get_slabstat(&slabstat);
+
 		int guess = slabstat.socks+slabstat.tcp_syns;
 		if (f->states&(1<<SS_TIME_WAIT))
 			guess += slabstat.tcp_tws;
@@ -2309,6 +2317,8 @@ int print_summary(void)
 	if (get_snmp_int("Tcp:", "CurrEstab", &sn.tcp_estab) < 0)
 		perror("ss: get_snmpstat");
 
+	get_slabstat(&slabstat);
+
 	printf("Total: %d (kernel %d)\n", s.socks, slabstat.socks);
 
 	printf("TCP:   %d (estab %d, closed %d, orphaned %d, synrecv %d, timewait %d/%d), ports %d\n",
@@ -2625,8 +2635,6 @@ int main(int argc, char *argv[])
 	argc -= optind;
 	argv += optind;
 
-	get_slabstat(&slabstat);
-
 	if (do_summary) {
 		print_summary();
 		if (do_default && argc == 0)
-- 
2.5.0

